[gcode_macro PRINT_START]
gcode:
    {% set extruder_temp = params.EXTRUDER_TEMP | float %}
    {% set bed_temp = params.BED_TEMP | float %}
    {% set is_printer_ready = ("xyz" in printer.toolhead.homed_axes) and printer.quad_gantry_level.applied %}

    STOP_HEAT_SOAK
    M140 S{bed_temp}
    M104 S{extruder_temp * 0.75}

    UPDATE_DELAYED_GCODE ID=filter_off DURATION=0
    _SET_FAN_SPEED FAN=Nevermore SPEED=0.9
    CG32 EXTRUDER_TEMP={extruder_temp}
    _GET_BED_MESH BED_TEMP={bed_temp} EXTRUDER_TEMP={extruder_temp}

    {% if is_printer_ready %}
        _CALIBRATE_Z EXTRUDER_TEMP={extruder_temp} ENDING_TEMP={extruder_temp * 0.85}
    {% endif %}

    _status_ready
    _PARKPURGE

    _status_heating
    M190 S{bed_temp}
    M109 S{extruder_temp}

    PREPARE_NOZZLE EXTRUDER_TEMP={extruder_temp} SKIP_OOZE_CLEAN={True} DO_PURGE={False} ENDING_TEMP={extruder_temp}
    _PRIME_LINE

    _status_printing
