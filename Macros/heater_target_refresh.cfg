[gcode_macro _HEATER_TARGET_REFRESH]
description: Workaround for sporadic heater suspending off the hotend.
variable_extruder_temp: 0
variable_bed_temp: 0
gcode:
    {% set extruder_temp = params.EXTRUDER_TEMP | default(printer["gcode_macro _HEATER_TARGET_REFRESH"].extruder_temp) | int %}
    {% set bed_temp = params.BED_TEMP | default(printer["gcode_macro _HEATER_TARGET_REFRESH"].bed_temp) | int %}
    {% set duration = params.DURATION | default(5) | int %}

    SET_GCODE_VARIABLE MACRO=_HEATER_TARGET_REFRESH VARIABLE=extruder_temp VALUE={extruder_temp}
    SET_GCODE_VARIABLE MACRO=_HEATER_TARGET_REFRESH VARIABLE=bed_temp VALUE={bed_temp}

    M104 S{extruder_temp}
    M140 S{bed_temp}

    UPDATE_DELAYED_GCODE ID=_HEATER_TARGET_LOOP DURATION={duration}

[delayed_gcode _HEATER_TARGET_LOOP]
gcode:
    _HEATER_TARGET_REFRESH

[gcode_macro _CANCEL_HEATER_TARGET_REFRESH]
gcode:
    UPDATE_DELAYED_GCODE ID=_HEATER_TARGET_LOOP DURATION=0