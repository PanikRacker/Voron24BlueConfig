[gcode_macro CG28]
gcode:
    SAVE_GCODE_STATE NAME=STATE_CG28
    {% if "x" not in printer.toolhead.homed_axes or "y" not in printer.toolhead.homed_axes or "z" not in printer.toolhead.homed_axes %}
        _status_homing
        {% if "xyz" not in printer.toolhead.homed_axes %}
            G28
            
        {% endif %}
        _status_off
    {% endif %}
    RESTORE_GCODE_STATE NAME=STATE_CG28

[gcode_macro CG28_old]
gcode:
    SAVE_GCODE_STATE NAME=STATE_CG28
    {% if "x" not in printer.toolhead.homed_axes or "y" not in printer.toolhead.homed_axes or "z" not in printer.toolhead.homed_axes %}
        _status_homing
        {% if "xyz" not in printer.toolhead.homed_axes %}
            G28
            _status_off
        {% endif %}
        UPDATE_DELAYED_GCODE ID=_CG28X DURATION=5
    {% endif %}
    RESTORE_GCODE_STATE NAME=STATE_CG28

[delayed_gcode _CG28X]
gcode:
    {% if "x" not in printer.toolhead.homed_axes %}
        _status_homing
        G28 X
        _status_off
    {% endif %}
    UPDATE_DELAYED_GCODE ID=_CG28Y DURATION=5

[delayed_gcode _CG28Y]
gcode:
    {% if "y" not in printer.toolhead.homed_axes %}
        _status_homing
        G28 Y
        _status_off
    {% endif %}
    UPDATE_DELAYED_GCODE ID=_CG28Z DURATION=5

[delayed_gcode _CG28Z]
gcode:
    {% if "z" not in printer.toolhead.homed_axes %}
        _status_calibrating_z
        G28 Z
        _status_off
    {% endif %}