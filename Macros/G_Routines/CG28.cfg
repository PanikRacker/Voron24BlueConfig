[gcode_macro CG28]
gcode:
    SAVE_GCODE_STATE NAME=STATE_CG28
    {% if "x" not in printer.toolhead.homed_axes or "y" not in printer.toolhead.homed_axes or "z" not in printer.toolhead.homed_axes %}
        _status_homing
        {% if printer.toolhead.homed_axes == "xyz" %}
            G28
        {% endif %}
        {% if "x" not in printer.toolhead.homed_axes %}
            G28 X
        {% endif %}
        {% if "y" not in printer.toolhead.homed_axes %}
            G28 Y
        {% endif %}
        {% if "y" not in printer.toolhead.homed_axes %}
            _status_calibrating_z
            G28 Z
        {% endif %}
        _status_off
    {% endif %}
    RESTORE_GCODE_STATE NAME=STATE_CG28