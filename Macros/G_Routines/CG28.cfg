[gcode_macro CG28]
gcode:
    SAVE_GCODE_STATE NAME=STATE_CG28
    {% if "x" not in printer.toolhead.homed_axes or "y" not in printer.toolhead.homed_axes or "z" not in printer.toolhead.homed_axes %}
        _status_homing
        {% if "xyz" not in printer.toolhead.homed_axes %}
            G28
            {% if printer.extruder.target > 0 %}
                PREPARE_NOZZLE EXTRUDER_TEMP={printer.extruder.target} SKIP_OOZE_CLEAN={True}
                _CALIBRATE_Z EXTRUDER_TEMP={printer.extruder.target} ENDING_TEMP={printer.extruder.target * 0.85}
            {% endif %}
        {% endif %}
        {% if "x" not in printer.toolhead.homed_axes and "y" not in printer.toolhead.homed_axes and "z" in printer.toolhead.homed_axes %}
            G28 X Y
        {% endif %}
        {% if "x" not in printer.toolhead.homed_axes and "y" in printer.toolhead.homed_axes and "z" not in printer.toolhead.homed_axes %}
            G28 X Z
        {% endif %}
        {% if "x" in printer.toolhead.homed_axes and "y" not in printer.toolhead.homed_axes and "z" not in printer.toolhead.homed_axes %}
            G28 Y Z
        {% endif %}
        {% if "x" in printer.toolhead.homed_axes and "y" in printer.toolhead.homed_axes and "z" not in printer.toolhead.homed_axes %}
            _CALIBRATE_Z
        {% endif %}
        _status_ready
    {% else %}
        _VERBOSE MSG="Printer is already homed"
    {% endif %}
    RESTORE_GCODE_STATE NAME=STATE_CG28