[pause_resume]
[gcode_macro PAUSE]
description: Pause the actual running print
variable_location: "pause"
rename_existing: PAUSE_BASE
gcode:
    {% set location = params.LOCATION | default("pause") | lower %}
    {% set filament_change_enabled = "filament_change" in printer.save_variables.variables and printer.save_variables.variables.filament_change %}
    {% set extruderTarget = printer.extruder.target %}

    SET_GCODE_VARIABLE MACRO=PAUSE VARIABLE=location VALUE='{location}'

    PAUSE_BASE
    UPDATE_DELAYED_GCODE ID=TOOLHEAD_PARK_PAUSE DURATION=1

    {% if filament_change_enabled and printer.idle_timeout.state == "Printing" %}
        ;FILAMENT_UNLOAD EXTRUDER_TEMP={(extruderTarget * 0.95)}
    {% else %}
        ;_TOOLHEAD_PARK_PAUSE_CANCEL
        _DEBUG MSG="TODO: create new parking position"
    {% endif %}

[delayed_gcode TOOLHEAD_PARK_PAUSE]
gcode:
    {% set pause = printer['gcode_macro PAUSE'] %}
    _PARK_SAFE LOCATION={pause.location}

[gcode_macro _TOOLHEAD_PARK_PAUSE_CANCEL]
description: Helper: park toolhead used in PAUSE and CANCEL_PRINT
variable_extrude: 1.0
gcode:
    ##### set park positon for x and y #####
    # default is your max posion from your printer.cfg

    {% set x_park = printer.toolhead.axis_maximum.x | float - 5.0 %}
    {% set y_park = printer.toolhead.axis_maximum.y | float - 5.0 %}
    {% set z_park_delta = 2.0 %}

    ##### calculate save lift position #####
    {% set max_z = printer.toolhead.axis_maximum.z | float %}
    {% set current_z = printer.toolhead.position.z | float %}
    {% if current_z < (max_z - z_park_delta) %}
        {% set z_safe = z_park_delta %}
    {% else %}
        {% set z_safe = max_z - current_z %}
    {% endif %}

    {% if printer.extruder.can_extrude | lower == "true" %}
        M83
        G1 E-{extrude} F2100

        {% if printer.gcode_move.absolute_extrude | lower == "true" %}
            M82
        {% endif %}
    {% endif %}

    G91
    G1 Z{z_safe} F900
    G90
    G1 Y{printer.toolhead.axis_maximum.y-5}

    {% if "filament_change" in printer.save_variables.variables and printer.save_variables.variables.filament_change %}
        _PARKPURGE
    {% endif %}

    {% if printer.gcode_move.absolute_coordinates | lower == "false" %}
        G91
    {% endif %}