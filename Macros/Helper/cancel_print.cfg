[gcode_macro CANCEL_PRINT]
rename_existing: CANCEL_PRINT_BASE
gcode:
    {% set run_print_end = ("xyz" in printer.toolhead.homed_axes) and printer.idle_timeout.state == "Printing" %}
    LIGHTSWITCH_ON
    CANCEL_HEAT_SOAK
    CANCEL_PRINT_BASE
    {% if run_print_end %}
        UPDATE_DELAYED_GCODE ID=PRINT_END_DELAYED DURATION=5
    {% endif %}

[delayed_gcode PRINT_END_DELAYED]
gcode:
    PRINT_END