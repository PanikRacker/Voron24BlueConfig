[gcode_macro _CALIBRATE_Z]
gcode:
    {% set extruder_temp = params.EXTRUDER_TEMP | default(0) | float %}
    {% set ending_temp = params.ENDING_TEMP | default(printer.extruder.target) | float %}

    SAVE_GCODE_STATE NAME=STATE_CALIBRATE_Z

    {% if extruder_temp > 0 %}
        PREPARE_NOZZLE EXTRUDER_TEMP={extruder_temp} ENDING_TEMP={ending_temp}
    {% endif %}
    _status_calibrating_z
    M220 S100
    G1 X207 Y300 F20000
    M221
    G28 Z
    _status_ready

    RESTORE_GCODE_STATE NAME=STATE_CALIBRATE_Z