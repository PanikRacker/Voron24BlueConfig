[gcode_macro CQGL]
gcode:
    {% set CALIBRATE_Z = params.CALIBRATE_Z | default(True, True) %}
    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP | default(0) | float %}
    {% set PARK_BED = params.PARK_BED | default(True, True) %}

    {% if printer.quad_gantry_level.applied == False %}
        CG28
        PREPARE_NOZZLE EXTRUDER_TEMP={EXTRUDER_TEMP * 0.9} SKIP_OOZE_CLEAN={True}
        _status_leveling
        QUAD_GANTRY_LEVEL
        {% if CALIBRATE_Z %}
            PREPARE_NOZZLE EXTRUDER_TEMP={EXTRUDER_TEMP} ENDING_TEMP={EXTRUDER_TEMP * 0.85}
            _status_calibrating_z
            G28 Z
        {% endif %}
        {% if PARK_BED %}
            _status_ready
            PARKBED
        {% endif %}
        _status_off
    {% endif %}