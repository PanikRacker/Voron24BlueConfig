[gcode_macro CQGL]
gcode:
    {% set var1 = params.CALIBRATE_Z | replace('True', '=True') | replace('False', '=False') | default(True, True) %}
    {% set var2 = params.EXTRUDER_TEMP | default(0) | float %}
    {% set var3 = params.PARK_BED | replace('True', '=True') | replace('False', '=False') | default(True, True) %}

    SET_GCODE_VARIABLE MACRO=CQGL VARIABLE=calibrate_z VALUE={var1}
    SET_GCODE_VARIABLE MACRO=CQGL VARIABLE=extruder_temp VALUE={var2}
    SET_GCODE_VARIABLE MACRO=CQGL VARIABLE=park_bed VALUE={var3}

    {% if printer.quad_gantry_level.applied == False %}
        CG28
        PREPARE_NOZZLE EXTRUDER_TEMP={extruder_temp * 0.9} SKIP_OOZE_CLEAN={True}
        _status_leveling
        QUAD_GANTRY_LEVEL
        {% if calibrate_z %}
            PREPARE_NOZZLE EXTRUDER_TEMP={extruder_temp} ENDING_TEMP={extruder_temp * 0.85}
            _status_calibrating_z
            G28 Z
        {% endif %}
        {% if park_bed %}
            _status_ready
            PARKBED
        {% endif %}
        _status_off
    {% endif %}