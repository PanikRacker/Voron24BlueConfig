[gcode_macro CQGL]
gcode:
    {% set calibrate_z = params.CALIBRATE_Z | default(True) %}
    {% set extruder_temp = params.EXTRUDER_TEMP | default(0) | float %}

    {% if printer.quad_gantry_level.applied == False %}
        CG28
        PREPARE_NOZZLE EXTRUDER_TEMP={extruder_temp * 0.9} SKIP_OOZE_CLEAN={True}
        _status_leveling
        QUAD_GANTRY_LEVEL
        {% if calibrate_z %}
            PREPARE_NOZZLE EXTRUDER_TEMP={extruder_temp} ENDING_TEMP={extruder_temp * 0.85}
            _status_calibrating_z
            G28 Z
        {% endif %}
        _status_off
    {% endif %}