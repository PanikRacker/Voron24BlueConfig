[gcode_macro _get_bed_mesh]
gcode:
    {% set BED_TEMP = params.BED_TEMP | default(0) | float %}
    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP | default(0) | float %}
    {% set PARK_BED = params.PARK_BED | default(True) %}
    {% set CALIBRATE_HOT = BED_TEMP > 0 %}

    {% if "default" not in printer.bed_mesh.profiles %}
        {% if EXTRUDER_TEMP > 0 %}
            PREPARE_NOZZLE
        {% endif %}
        _status_busy
        M109 S{printer["extruder"].temperature * 0.75}
        CG28
        CQGL
        {% if CALIBRATE_HOT %}
            _status_heating
            M190 S{BED_TEMP}
        {% endif %}
        _status_meshing
        BED_MESH_CALIBRATE
        {% if PARK_BED %}
            _status_ready
            PARKBED
        {% endif %}
        _status_off
    {% endif %}
        BED_MESH_PROFILE LOAD=default
        BED_MESH_OUTPUT PGP=1