[gcode_macro _GET_BED_MESH]
gcode:
    {% set BED_TEMP = params.BED_TEMP | default(0) | float %}
    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP | default(0) | float %}

    {% if "default" not in printer.bed_mesh.profiles %}
        SAVE_GCODE_STATE NAME=STATE_GET_BED_MESH

        {% if EXTRUDER_TEMP > 0 %}
            PREPARE_NOZZLE EXTRUDER_TEMP={EXTRUDER_TEMP * 0.9} SKIP_OOZE_CLEAN={True} DO_PURGE={False}
        {% endif %}
        CG28
        {% if BED_TEMP > 0 %}
            _status_heating
            M190 S{BED_TEMP}
        {% endif %}
        CQGL
        _status_meshing
        BED_MESH_CALIBRATE
        _status_off

        RESTORE_GCODE_STATE NAME=STATE_GET_BED_MESH
    {% endif %}
        BED_MESH_PROFILE LOAD=default
        BED_MESH_OUTPUT PGP=1