[gcode_macro PREPARE_NOZZLE]
gcode:
    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP | default(0) | float %}
    {% set SKIP_OOZE_CLEAN = params.SKIP_OOZE_CLEAN | default(False) %}
    {% set ENDING_TEMP = params.ENDING_TEMP | default(printer.extruder.target) | float %}
    {% set CLEAN_HOT = EXTRUDER_TEMP > 0 %}

    {% if CLEAN_HOT %}
        M104 S{EXTRUDER_TEMP}
    {% endif %}
    CG28
    {% if CLEAN_HOT %}
        PARKPURGE
        _status_heating
        M109 S{EXTRUDER_TEMP}
    {% endif %}
    _status_cleaning
    clean_nozzle
    {% if CLEAN_HOT and SKIP_OOZE_CLEAN == False %}
        M109 S{EXTRUDER_TEMP * 0.9}
        {% if ENDING_TEMP >= EXTRUDER_TEMP %}
            M104 S{EXTRUDER_TEMP * 0.75}
        {% endif %}
        clean_nozzle
        {% if ENDING_TEMP != printer.extruder.target %}
            M109 S{ENDING_TEMP}
        {% endif %}
        clean_nozzle
    {% endif %}
    M104 S{ENDING_TEMP}
    _status_off