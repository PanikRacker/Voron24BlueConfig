[gcode_macro PREPARE_NOZZLE]
gcode:
    {% set extruder_temp = params.EXTRUDER_TEMP | default(0) | float %}
    {% set skip_ooze_clean = params.SKIP_OOZE_CLEAN | default(False) %}
    {% set do_purge = params.DO_PURGE | default(True) %}
    {% set ending_temp = params.ENDING_TEMP | default(printer.extruder.target) | float %}
    {% set clean_hot = extruder_temp > 0 and do_purge == True %}

    {% if clean_hot %}
        M104 S{extruder_temp}
    {% endif %}

    CG28

    {% if clean_hot %}
        _status_heating
        PARKPURGE
        M109 S{extruder_temp}
    {% endif %}

    _status_cleaning
    clean_nozzle DO_PURGE={do_purge}

    {% if clean_hot and skip_ooze_clean == False %}
        M109 S{extruder_temp * 0.9}
        M104 S{extruder_temp * 0.75}
        clean_nozzle DO_PURGE={False}
        {% if ending_temp != printer.extruder.target %}
            M109 S{ending_temp}
        {% endif %}
        clean_nozzle DO_PURGE={False}
    {% endif %}

    M104 S{ending_temp}
    _status_off