[gcode_macro M600]
description: Filament change
gcode: 
    PAUSE Z_MIN=50
    UNLOAD_FILAMENT EXTRUDER_TEMP={(printer.extruder.target * 0.9)}

[gcode_macro FILAMENT_UNLOAD]
gcode:
    {% set extruder_temp = params.EXTRUDER_TEMP | default(230) | int %}
    SAVE_GCODE_STATE NAME=unload_state
    _DEBUG MSG="Unload filament"

    {% if printer['pause_resume'].is_paused == False %}
        _PREPARE_FILAMENT_CHANGE EXTRUDER_TEMP={extruder_temp}

        _DEBUG MSG="Form filament tip"
        _status_busy

        G91
        G0 E10 F360     ; extract a bit
        G0 E5 F3600     ; blob a bit
        G0 E-22 F3600   ; forming filament Tip for Rapido -> from ERCF V3 ercf_software.cfg 
        G0 E2 F300
        G0 E-2.1 F300
        G0 E2 F300
        G0 E-2.2 F300
        G0 E2 F300
        G0 E-2.3 F300
        G0 E2 F300
        G0 E-2.4 F300
        G0 E2 F300
        G0 E-2.5 F300
        G0 E2 F300
        G0 E-43 F300    ; Filament Tip cooldown till extruder gears for Rapido -> from ERCF V3 ercf_software.cfg 
        G0 E-100 F3600  ; aaand puke it out fast

        {% if printer.idle_timeout.state != "Printing" %}
            TURN_OFF_HEATERS
            PREPARE_NOZZLE EXTRUDER_TEMP={extruder_temp} SKIP_OOZE_CLEAN={True}
            _PARKPURGE
        {% endif %}

    {% else %}
      _status_busy

      G91
      G0 E10 F360       ; extract a bit
      G0 E5 F3600       ; blob a bit
      G0 E-150 F3600
    {% endif %}

    G90
    _status_ready

    CLEAR_ACTIVE_SPOOL
    _DEBUG MSG="Select spool after loading new filament"

    RESTORE_GCODE_STATE NAME=unload_state

[gcode_macro FILAMENT_LOAD]
gcode:
    {% set extruder_temp = params.EXTRUDER_TEMP | default(230)  |int %}
    SAVE_GCODE_STATE NAME=load_state
    _DEBUG MSG="Load filament"
    _status_busy

    {% if printer['pause_resume'].is_paused == False %}
        _PREPARE_FILAMENT_CHANGE EXTRUDER_TEMP={extruder_temp}

        G91
        G1 E200 F360    ; extract 200mm for colour change
        G1 E5 F3600     ; blob for cleaning Nozzle
        G1 E-10 F1200   ; retract for non oozing

        PREPARE_NOZZLE EXTRUDER_TEMP={extruder_temp} SKIP_OOZE_CLEAN={True}

        {% if printer.idle_timeout.state != "Printing" %}
            TURN_OFF_HEATERS
            _PARKPURGE
        {% endif %}

        _status_ready

        RESTORE_GCODE_STATE NAME=load_state
    {% else %}
        _status_busy

        G91
        G1 E200 F360    ; extract 200mm for colour change
        G1 E5 F3600     ; blob for cleaning Nozzle
        G1 E-1 F1200    ; retract for non oozing
        G90

        _status_printing
        RESTORE_GCODE_STATE NAME=load_state
        RESUME
    {% endif %}

    _DEBUG MSG="Select spool for new filament"

[gcode_macro _PREPARE_FILAMENT_CHANGE]
gcode:
    {% set extruder_temp = params.EXTRUDER_TEMP | default(230) | int %}
    M104 S{extruder_temp}
    _DEBUG MSG="Move toolhead backwards savely"
    CG28
    G0 Y{printer.toolhead.axis_maximum.y-5}
    _PARKPURGE
    _status_heating
    _DEBUG MSG="Wait for extruder to reach requested temperature for filament change"
    M109 S{extruder_temp}
