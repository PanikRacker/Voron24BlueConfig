[gcode_macro SWITCH_OFF_LIGHTS]
gcode:
    {% set DURATION = params.DURATION | default(1) | int %}
    
    UPDATE_DELAYED_GCODE ID=SWITCH_OFF_HEADLIGHT DURATION={DURATION}

[delayed_gcode CONDITIONAL_LIGHTSWITCH]
gcode:
    {% if printer.idle_timeout.state == "Printing" %}
        UPDATE_DELAYED_GCODE ID=CONDITIONAL_LIGHTSWITCH DURATION=0
        SWITCH_OFF_LIGHTS
    {% endif %}

[delayed_gcode CHECK_LIGHT_ACTIVITY]
gcode:
    {% if printer.idle_timeout.state == "Printing" %}
        UPDATE_DELAYED_GCODE ID=CONDITIONAL_LIGHTSWITCH DURATION=1
    {% else %}
        UPDATE_DELAYED_GCODE ID=CHECK_LIGHT_ACTIVITY DURATION=300
    {% endif %}

[gcode_macro _TURN_OFF_LIGHT_CHECK]
gcode:
    UPDATE_DELAYED_GCODE ID=CHECK_LIGHT_ACTIVITY DURATION=0
    UPDATE_DELAYED_GCODE ID=CONDITIONAL_LIGHTSWITCH DURATION=0
