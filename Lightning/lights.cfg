##################
# Lightswitch ON #
##################

[gcode_macro LIGHTSWITCH_ON]
variable_duration: 1
gcode:
    {% set duration = params.DURATION | default(1) | int %}
    SET_GCODE_VARIABLE MACRO=LIGHTSWITCH_ON VARIABLE=duration VALUE={duration}
    {% if duration == 1 %}
        _CANCEL_ACTIVE_LIGHTSWITCH_ON
        {% if printer.idle_timeout.state != "Printing" %}
            _CANCEL_ACTIVE_LIGHTSWITCH_OFF
        {% endif %}
    {% endif %}
    UPDATE_DELAYED_GCODE ID=SWITCH_ON_ACTION DURATION={duration}

[delayed_gcode SWITCH_ON_ACTION]
gcode:
    {% set duration = printer["gcode_macro LIGHTSWITCH_ON"].duration | default(300) | int %}
    {% if duration == 1 %}
        _RESET_SWITCH_OFF
        _LOG_RESET_INTERVAL
    {% else %}
        _RESET_SWITCH_OFF INTERVAL={duration}
    {% endif %}
    SWITCH_ON_HEADLIGHT

[gcode_macro _CANCEL_ACTIVE_LIGHTSWITCH_ON]
gcode:
    UPDATE_DELAYED_GCODE ID=SWITCH_ON_ACTION DURATION=0

###################
# Lightswitch OFF #
###################

[gcode_macro LIGHTSWITCH_OFF]
variable_duration: 1
gcode:
    {% set duration = params.DURATION | default(1) | int %}
    SET_GCODE_VARIABLE MACRO=LIGHTSWITCH_OFF VARIABLE=duration VALUE={duration}
    {% if duration == 1 %}
        _CANCEL_ACTIVE_LIGHTSWITCH_OFF
        {% if printer.idle_timeout.state != "Printing" %}
            _CANCEL_ACTIVE_LIGHTSWITCH_ON
        {% endif %}
    {% endif %}
    UPDATE_DELAYED_GCODE ID=SWITCH_OFF_ACTION DURATION={duration}

[delayed_gcode SWITCH_OFF_ACTION]
gcode:
    {% set duration = printer["gcode_macro LIGHTSWITCH_OFF"].duration | default(300) | int %}
    {% if duration == 1 %}
        _RESET_SWITCH_OFF
        _LOG_RESET_INTERVAL
    {% else %}
        _RESET_SWITCH_OFF INTERVAL={duration}
    {% endif %}
    SWITCH_OFF_HEADLIGHT

[gcode_macro _RESET_SWITCH_OFF]
gcode:
    {% set interval = params.INTERVAL | default(300) | int %}
    {% if printer.idle_timeout.state == "Printing" %}
        _CANCEL_ACTIVE_LIGHTSWITCH_OFF
        UPDATE_DELAYED_GCODE ID=SWITCH_OFF_ACTION DURATION={interval}
    {% endif %}

[gcode_macro _CANCEL_ACTIVE_LIGHTSWITCH_OFF]
gcode:
    UPDATE_DELAYED_GCODE ID=SWITCH_OFF_ACTION DURATION=0

[gcode_macro _LOG_RESET_INTERVAL]
gcode:
    {% set interval = params.INTERVAL | default(300) | int %}
    {% if printer.idle_timeout.state == "Printing" and interval >= 60 %}
        _DEBUG MSG="Switching off lights again in {(interval / 60.0)} minutes"
    {% endif %}
